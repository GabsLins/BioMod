# 1. MAPA DE ADEQUABILIDADE DO ENSEMBLE
ensemble_path <- file.path(output_dir, "ensemble_projection_4layers_teste43.tif")
ensemble_raster <- rast(ensemble_path)

suitability_map <- ggplot() +
  geom_spatraster(data = ensemble_raster) +
  geom_sf(data = countries, fill = NA, color = "black", linewidth = 0.2) +
  geom_point(data = pres_coords, aes(x = lon, y = lat), 
             color = "red", size = 1, alpha = 0.6) +
  scale_fill_viridis_c(option = "plasma", name = "Adequabilidade", na.value = NA) +
  coord_sf(xlim = c(-120, -30), ylim = c(-60, 30)) +
  theme_minimal() +
  labs(
    title = "Mapa de Adequabilidade do Habitat - Ensemble",
    subtitle = "Modelo consensual combinando todos os algoritmos"
  ) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5))

# 2. GRÁFICO DE IMPORTÂNCIA DAS VARIÁVEIS
importance_plot <- ggplot(importance_df, aes(x = reorder(var, importance), y = importance, fill = var)) +
  geom_col(alpha = 0.8) +
  geom_text(aes(label = sprintf("%.3f", importance)), 
            hjust = -0.2, size = 4, fontface = "bold") +
  coord_flip(ylim = c(0, max(importance_df$importance) * 1.2)) +
  scale_fill_viridis_d(option = "C") +
  theme_minimal() +
  labs(
    x = "", 
    y = "Importância", 
    title = "Importância das Variáveis Ambientais",
    subtitle = "Contribuição relativa no modelo ensemble"
  ) +
  theme(legend.position = "none")

# 3. DIAGNÓSTICO DAS VARIÁVEIS AMBIENTAIS - MAPA + VIOLIN PLOT AO LADO
# Função para criar layout mapa + violin plot LADO A LADO
create_variable_side_panel <- function(r, varname, pres_coords, countries, importance_value) {
  
  # Mapa da variável (lado esquerdo)
  map_plot <- ggplot() +
    geom_spatraster(data = r) +
    geom_sf(data = countries, fill = NA, color = "black", linewidth = 0.1) +
    geom_point(data = pres_coords, aes(x = lon, y = lat), 
               color = "red", size = 0.8, alpha = 0.7) +
    scale_fill_viridis_c(option = "viridis", name = varname, na.value = NA) +
    coord_sf(xlim = c(-120, -30), ylim = c(-60, 30)) +
    theme_minimal() +
    labs(
      title = paste("Distribuição Espacial -", varname),
      subtitle = paste("Importância no modelo:", round(importance_value, 3))
    ) +
    theme(
      plot.title = element_text(size = 11, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 9, hjust = 0.5),
      legend.position = "right",
      axis.text = element_text(size = 7)
    )
  
  # Violin plot da variável (lado direito)
  # Extrair valores nas presenças
  vals_presenca <- terra::extract(r, pres_coords[, c("lon", "lat")])[,2]
  vals_presenca <- vals_presenca[!is.na(vals_presenca)]
  
  # Amostrar valores de fundo
  vals_fundo <- sample(values(r)[!is.na(values(r))], 
                       min(600, sum(!is.na(values(r)))))
  vals_fundo <- vals_fundo[!is.na(vals_fundo)]
  
  # Criar dataframe para o violin plot
  violin_data <- data.frame(
    valor = c(vals_presenca, vals_fundo),
    tipo = c(rep("Presença", length(vals_presenca)), 
             rep("Fundo", length(vals_fundo)))
  )
  
  # Calcular estatísticas para anotações
  stats <- violin_data %>% 
    group_by(tipo) %>% 
    summarise(
      media = mean(valor, na.rm = TRUE),
      mediana = median(valor, na.rm = TRUE),
      n = n()
    )
  
  violin_plot <- ggplot(violin_data, aes(x = tipo, y = valor, fill = tipo)) +
    geom_violin(alpha = 0.7, trim = TRUE, width = 0.8) +
    geom_boxplot(width = 0.15, alpha = 0.9, outlier.size = 0.8) +
    geom_point(position = position_jitter(width = 0.2), alpha = 0.4, size = 1) +
    stat_summary(fun = mean, geom = "point", shape = 23, size = 3, 
                 fill = "white", color = "black") +
    scale_fill_manual(values = c("Presença" = "#FF6B6B", "Fundo" = "#4ECDC4")) +
    theme_minimal() +
    labs(
      x = "",
      y = varname,
      title = paste("Distribuição -", varname),
      subtitle = "Comparação: Presenças vs Área de Fundo"
    ) +
    theme(
      plot.title = element_text(size = 11, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 9, hjust = 0.5),
      legend.position = "none",
      axis.text = element_text(size = 9),
      axis.title.y = element_text(size = 10, face = "bold")
    ) +
    # Adicionar valores médios
    geom_text(data = stats, 
              aes(x = tipo, y = min(violin_data$valor), 
                  label = sprintf("Média: %.2f\nn: %d", media, n)),
              vjust = -1, size = 3, fontface = "bold", color = "black")
  
  # Combinar mapa e violin plot LADO A LADO
  side_by_side_plot <- map_plot | violin_plot
  
  return(side_by_side_plot)
}

# Criar painéis individuais para cada variável (mapa + violin lado a lado)
variable_side_panels <- list()
for (i in 1:length(names(env_stack_4layers))) {
  varname <- names(env_stack_4layers)[i]
  importance_value <- importance_df$importance[importance_df$var == varname]
  r <- env_stack_4layers[[varname]]
  
  variable_side_panels[[varname]] <- create_variable_side_panel(
    r, varname, pres_coords, countries, importance_value
  )
}

# Combinar todos os painéis de variáveis em grid 2x2 (cada célula contém mapa + violin)
variables_grid_side <- wrap_plots(variable_side_panels, ncol = 2, nrow = 2) +
  plot_annotation(
    title = "Análise das Variáveis Ambientais: Mapas e Distribuições",
    subtitle = "Cada variável mostra o mapa espacial (esquerda) e distribuição presenças vs fundo (direita)",
    theme = theme(
      plot.title = element_text(face = "bold", hjust = 0.5, size = 16),
      plot.subtitle = element_text(hjust = 0.5, size = 12)
    )
  )

# 4. VIOLIN PLOTS DE CONFIABILIDADE DOS MODELOS (compactos)
create_compact_evaluation_plot <- function(data, metric) {
  plot_data <- data[data$Métrica == metric, ]
  
  # Calcular estatísticas
  stats <- plot_data %>% 
    group_by(Modelo) %>% 
    summarise(
      media = mean(Valor, na.rm = TRUE),
      n = n()
    )
  
  ggplot(plot_data, aes(x = Modelo, y = Valor, fill = Modelo)) +
    geom_violin(alpha = 0.7, trim = TRUE, width = 0.8) +
    geom_boxplot(width = 0.2, alpha = 0.9, outlier.size = 1) +
    geom_jitter(width = 0.1, alpha = 0.4, size = 1) +
    stat_summary(fun = mean, geom = "point", shape = 23, size = 2.5, 
                 fill = "white", color = "black") +
    scale_fill_viridis_d(option = "magma", alpha = 0.8) +
    theme_minimal() +
    labs(
      title = paste("Desempenho dos Modelos -", metric),
      x = "Modelo",
      y = paste("Valor", metric)
    ) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      axis.text.y = element_text(size = 10),
      plot.title = element_text(face = "bold", hjust = 0.5, size = 12),
      legend.position = "none"
    ) +
    ylim(0, 1) +
    # Adicionar valores médios
    geom_text(data = stats, 
              aes(x = Modelo, y = 0.1, label = sprintf("%.3f", media)),
              vjust = -0.5, size = 3.5, fontface = "bold", color = "black")
}

# Criar avaliações compactas
tss_compact <- create_compact_evaluation_plot(combined_data, "TSS")
roc_compact <- create_compact_evaluation_plot(combined_data, "ROC")

# Combinar avaliações lado a lado
evaluation_side <- tss_compact | roc_compact +
  plot_annotation(
    title = "Avaliação da Confiabilidade dos Modelos",
    theme = theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 14))
  )

# 5. PAINEL FINAL CORRIGIDO - LAYOUT ORGANIZADO
# Estrutura:
# Linha 1: [Mapa Adequabilidade] + [Importância Variáveis]
# Linha 2: [Variável 1: Mapa | Violin]   [Variável 2: Mapa | Violin]
# Linha 3: [Variável 3: Mapa | Violin]   [Variável 4: Mapa | Violin]  
# Linha 4: [Avaliação TSS | Avaliação ROC]

final_panel_corrigido <- (suitability_map | importance_plot) / 
  variables_grid_side / 
  evaluation_side +
  plot_annotation(
    title = "RELATÓRIO COMPLETO - MODELAGEM DE NICHO ECOLÓGICO",
    subtitle = "Vampyrum spectrum - Análise Integrada com Visualização Otimizada",
    caption = paste("Gerado em", format(Sys.Date(), "%d/%m/%Y"),
                   "| Layout: Mapa + Violin Plot lado a lado para cada variável"),
    theme = theme(
      plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
      plot.subtitle = element_text(size = 16, hjust = 0.5),
      plot.caption = element_text(size = 10, hjust = 1)
    )
  )

# Salvar painel final corrigido
ggsave(file.path(output_dir, "04_Painel_Final_Corrigido_LadoaLado_teste333.png"), 
       final_panel_corrigido, width = 22, height = 24, dpi = 300)

# 6. VERSÃO ALTERNATIVA - LAYOUT MAIS COMPACTO
# Para variáveis com menos detalhes nos mapas
create_compact_variable_panel <- function(r, varname, pres_coords, countries, importance_value) {
  
  # Mapa mais compacto
  map_compact <- ggplot() +
    geom_spatraster(data = r) +
    geom_sf(data = countries, fill = NA, color = "black", linewidth = 0.05) +
    geom_point(data = pres_coords, aes(x = lon, y = lat), 
               color = "red", size = 0.3, alpha = 0.6) +
    scale_fill_viridis_c(option = "viridis", name = NULL, na.value = NA) +
    coord_sf(xlim = c(-120, -30), ylim = c(-60, 30)) +
    theme_minimal() +
    labs(title = paste(varname, "\nImp:", round(importance_value, 3))) +
    theme(
      plot.title = element_text(size = 9, face = "bold", hjust = 0.5),
      legend.position = "right",
      axis.text = element_text(size = 6),
      legend.key.height = unit(0.3, "cm")
    )
  
  # Violin plot compacto
  vals_presenca <- terra::extract(r, pres_coords[, c("lon", "lat")])[,2]
  vals_presenca <- vals_presenca[!is.na(vals_presenca)]
  vals_fundo <- sample(values(r)[!is.na(values(r))], 1000)
  vals_fundo <- vals_fundo[!is.na(vals_fundo)]
  
  violin_data <- data.frame(
    valor = c(vals_presenca, vals_fundo),
    tipo = c(rep("Presença", length(vals_presenca)), rep("Fundo", length(vals_fundo)))
  )
  
  violin_compact <- ggplot(violin_data, aes(x = tipo, y = valor, fill = tipo)) +
    geom_violin(alpha = 0.7, trim = TRUE, width = 0.6) +
    geom_boxplot(width = 0.1, alpha = 0.9, outlier.size = 0.5) +
    scale_fill_manual(values = c("Presença" = "#FF6B6B", "Fundo" = "#4ECDC4")) +
    theme_minimal() +
    labs(x = "", y = "") +
    theme(
      legend.position = "none",
      axis.text = element_text(size = 7),
      plot.margin = margin(2, 2, 2, 2, "mm")
    )
  
  return(map_compact | violin_compact)
}

# Criar versão compacta
compact_panels <- list()
for (i in 1:length(names(env_stack_4layers))) {
  varname <- names(env_stack_4layers)[i]
  importance_value <- importance_df$importance[importance_df$var == varname]
  r <- env_stack_4layers[[varname]]
  
  compact_panels[[varname]] <- create_compact_variable_panel(
    r, varname, pres_coords, countries, importance_value
  )
}

compact_grid <- wrap_plots(compact_panels, ncol = 2, nrow = 2) +
  plot_annotation(title = "Variáveis Ambientais (Versão Compacta)")

# Painel compacto final
final_panel_compacto <- (suitability_map | importance_plot) / 
  compact_grid / 
  evaluation_side +
  plot_annotation(
    title = "Análise Compacta - Vampyrum spectrum",
    theme = theme(plot.title = element_text(face = "bold", hjust = 0.5))
  )

ggsave(file.path(output_dir, "04B_Painel_Compacto_LadoaLado_teste43.png"), 
       final_panel_compacto, width = 18, height = 20, dpi = 300)

# 7. SALVAR PAINÉIS INDIVIDUAIS DAS VARIÁVEIS
cat("Salvando painéis individuais das variáveis (mapa + violin lado a lado)...\n")

for (varname in names(variable_side_panels)) {
  ggsave(file.path(output_dir, paste0("05_Painel_", varname, "_LadoaLado_teste333.png")), 
         variable_side_panels[[varname]], width = 16, height = 8, dpi = 300)
}

# 8. RELATÓRIO FINAL
cat("\n", rep("=", 70), "\n")
cat("RELATÓRIO FINAL - CORREÇÃO APLICADA: VIOLIN PLOTS AO LADO DOS MAPAS\n")
cat(rep("=", 70), "\n\n")

cat("✓ CORREÇÃO CONCLUÍDA: Violin plots posicionados AO LADO dos mapas\n")
cat("✓ LAYOUT OTIMIZADO:\n")
cat("  • Esquerda: Mapa espacial da variável\n") 
cat("  • Direita: Violin plot da distribuição (presenças vs fundo)\n")
cat("  • Grid 2x2 para as 4 variáveis ambientais\n")
cat("  • Visualização mais equilibrada e comparável\n\n")

cat("✓ ESTRUTURA DO PAINEL FINAL:\n")
cat("  1. LINHA 1: Mapa de adequabilidade + Importância das variáveis\n")
cat("  2. LINHA 2-3: Grid 2x2 com [Mapa | Violin] para cada variável\n")
cat("  3. LINHA 4: Avaliação dos modelos [TSS | ROC]\n\n")

cat("ARQUIVOS GERADOS:\n")
cat("- 04_Painel_Final_Corrigido_LadoaLado_teste333.png (painel completo)\n")
cat("- 04B_Painel_Compacto_LadoaLado_teste333.png (versão compacta)\n")
cat("- 05_Painel_*_LadoaLado_teste333.png (painéis individuais das variáveis)\n\n")

cat("VISUALIZAÇÃO DAS VARIÁVEIS:\n")
for(varname in names(env_stack_4layers)) {
  cat(sprintf("  • %s: Mapa espacial + Distribuição presenças/fundo\n", varname))
}

cat("\n", rep("=", 70), "\n")
cat("LAYOUT CORRIGIDO COM SUCESSO! ✅\n")
cat("Violin plots agora estão AO LADO dos mapas das variáveis\n")
cat(rep("=", 70), "\n")

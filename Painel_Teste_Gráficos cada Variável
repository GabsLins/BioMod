# RODAR APÓS O ENSEMBLE 4 LAYERS
# NOVO CÓDIGO: PAINEL DE DIAGNÓSTICO E VISUALIZAÇÃO
# -------------------------------------------------------------------
library(terra)
library(ggplot2)
library(dplyr)
library(patchwork)
library(tidyr)

# 1. Defina a função para criar os painéis de diagnóstico
make_panel <- function(r, varname, pres_coords, n_bg = 1000) {
  
  # Mapa da variável ambiental com pontos de presença
  map_env <- ggplot() +
    geom_spatraster(data = r) +
    scale_fill_viridis_c(option = "C") +
    geom_point(data = pres_coords, aes(x = lon, y = lat), 
               color = "red", size = 1, alpha = 0.6) +
    coord_equal() +
    theme_minimal() +
    labs(fill = varname, title = paste("Mapa de", varname))
  
  # Extrai valores para presenças e fundo
  vals_pres <- terra::extract(r, pres_coords) %>% 
    mutate(tipo = "Presença") %>% 
    select(all_of(varname), tipo)
  
  set.seed(123) # Para reproducibilidade
  bg_points <- spatSample(r, size = n_bg, method = "random", 
                          as.points = TRUE, na.rm = TRUE)
  vals_bg <- terra::extract(r, bg_points) %>% 
    mutate(tipo = "Fundo") %>% 
    select(all_of(varname), tipo)
  
  # Combina os dados
  vals_combined <- bind_rows(vals_pres, vals_bg)
  
  # Gráfico de violino para comparar distribuições
  violin <- ggplot(vals_combined, aes(x = tipo, y = .data[[varname]], fill = tipo)) +
    geom_violin(trim = FALSE, alpha = 0.7) +
    geom_boxplot(width = 0.1, fill = "white", alpha = 0.5) +
    scale_fill_manual(values = c("Presença" = "tomato", "Fundo" = "steelblue")) +
    theme_minimal() +
    labs(x = "", y = varname, title = paste("Distribuição de", varname)) +
    theme(legend.position = "none")
  
  # Retorna os dois gráficos lado a lado
  map_env + violin
}

# 2. Gere o painel de diagnóstico para cada variável ambiental
#    (Usando suas variáveis originais 'myExpl' e presenças 'presence_coords')
variable_plots <- list()
for(i in 1:nlyr(myExpl)) {
  varname <- names(myExpl)[i]
  cat("Processando:", varname, "\n")
  single_layer <- myExpl[[i]]
  variable_plots[[i]] <- make_panel(single_layer, varname, presence_coords)
}

# 3. Gere o mapa final de adequabilidade do ensemble
#    (Usando o raster 'ensemble_suitability' que você já projetou)
suitability_map <- ggplot() +
  geom_spatraster(data = ensemble_suitability) +
  scale_fill_viridis_c(option = "plasma", na.value = NA) +
  geom_point(data = presence_coords, aes(x = lon, y = lat), 
             color = "red", size = 0.8, alpha = 0.9) +
  coord_equal() +
  theme_minimal() +
  labs(fill = "Adequabilidade", 
       title = "Modelo Ensemble: Mapa de Adequabilidade de Habitat",
       subtitle = "Pontos vermelhos: registros de ocorrência")

# 4. Organize e salve TODAS as visualizações

# Salve o painel de variáveis (pode ser grande, ajuste o tamanho)
ggsave("01_Diagnostico_Variaveis.png", 
       wrap_plots(variable_plots, ncol = 2), 
       width = 16, height = 4 * ceiling(length(variable_plots)/2), 
       dpi = 300)

# Salve o mapa de adequabilidade
ggsave("02_Mapa_Adequabilidade_Ensemble.png", 
       suitability_map, 
       width = 10, height = 8, dpi = 300)

# Opcional: Gere um resumo das importâncias das variáveis (se disponível)
# Nota: Isso depende de o BIOMOD2 ter calculado a importância.
var_import <- get_variables_importance(myBiomodEM)
if(!is.null(var_import)) {
  var_import_df <- as.data.frame(t(apply(var_import, c(1,2), mean)))
  var_import_df$variavel <- rownames(var_import_df)
  var_import_long <- pivot_longer(var_import_df, -variavel, names_to = "modelo", values_to = "importancia")
  
  importance_plot <- ggplot(var_import_long, aes(x = reorder(variavel, importancia, mean), y = importancia)) +
    geom_boxplot(fill = "lightblue") +
    coord_flip() +
    theme_minimal() +
    labs(x = "Variável", y = "Importância Relativa Média", 
         title = "Importância das Variáveis no Modelo Ensemble")
  
  ggsave("03_Importancia_Variaveis.png", importance_plot, width = 10, height = 6, dpi = 300)
}

cat("\nProcesso concluído! Verifique os arquivos salvos:\n")
cat("- 01_Diagnostico_Variaveis.png: Painel de diagnóstico ambiental\n")
cat("- 02_Mapa_Adequabilidade_Ensemble.png: Mapa final de habitat adequado\n")
cat("- 03_Importancia_Variaveis.png: Gráfico de importância (se disponível)\n")
